---
title: MySQL学习笔记（一）一条SQL查询语句是如何执行的
date: 2019-06-08 22:23:25
tags:
categories: 
- MySQL
---
*数据库和MySQL可以说是现代程序员必会的一项技术，某种程度上来说，数据库知识的掌握程度甚至直接反映了一名程序员的实力水平，本系列学习笔记是基于极客时间《MySQL实战45讲》进行总结的，算是对学习过程的一个总结和提高。*

<!-- more -->
 1．MySQL 的基本架构示意图：
![](/image/mysql_base.jpg)

 2．大体上来讲分为server层和存储引擎层

 3．Server 层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖MySQL的大多数核心服务功能，另外一些内置函数如日期、时间、数学等也在这一层，还有就是所有需要跨存储引擎的功能也在这层实现，例如存储过程、触发器、视图。而存储引擎层负责数据的存储和提取，支持多种存储引擎如InnoDB、MyISAM、Memory，其中InnoDB应该是使用最广泛且默认的存储引擎。
 
 4．连接器。
想使用MySQL的服务肯定是要先连接到MySQL数据库上，而连接器就是负责建立连接、获取权限、维持和管理连接；
*mysql -h$ip -P$port -u$user -p*
在完成TCP握手之后，连接器就会验证你的用户名和密码，用户成功建立连接后即使用管理员账号对该用户权限进行修改也不会影响已建立的连接，只有在下次连接才会生效；
通过show processlist可以看到所有连接，默认断开时间8小时，由参数wait_timeout控制；
众所周知，建立连接一般属于比较重量级的操作，一般尽量使用数据库长连接，但是长连接存在的问题是MySQL可能因此占用大量内存，可能最终会导致OOM的发生，导致被系统杀掉。

 5．查询缓存
**大多数情况下建议不要使用查询缓存功能，因为往往弊大于利。**只要对一个表有更新，那么表上的所有查询缓存都会失效，所以对于频繁更新的表来说，缓存的命中率会非常低，除非是某种静态表或者配置表等很长时间才会更新一次，而该功能甚至在8.0中被直接删除了，所以建议就是不要在系统中使用这个功能。

6．分析器
先做词法分析，再做语法分析

7．优化器
表中有多个索引时决定使用哪个索引等，语句的执行方案在此时确定。

8．执行器
会优先判断用户有没有对该表的查询权限，随后打开表继续查询；
没有使用索引的语句会从表的第一行开始取数判断是否满足条件，直到最后一行并最终返回结果，有索引的查询也是类似；
慢查询日志中的rows_examined字段就代表了sql执行过程中扫描了多少行。

## 每课一练
问题：如果表T中没有字段c，而你执行了语句select \* from T where k = 1，那么肯定会报错"Unknown column 'k' in 'where clause' "。你觉得这个错误是在哪个阶段报出来的？

-------

答案：在分析器报错，分析器负责处理语法，解析查询。

****

极客时间版权所有: https://time.geekbang.org/column/article/68319
