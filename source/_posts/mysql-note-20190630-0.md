---
title: MySQL学习笔记（三）深入浅出索引（上）
date: 2019-06-30 14:59:55
tags:
categories:
- MySQL
---
***本文要点：主键索引，非主键索引，n叉树，索引维护***
<!--more-->

## 索引的常见类型

索引也是被抽象出来的一种概念，本质就是提高读写效率的数据结构，基本较为常见的数据结构有如下三种：

#### 哈希表
**哈希表**是一种基础的数据结构，以key-value形式存储数据，这种数据结构在一般情况下查找效率为O(1)，但是key值经过hash函数的计算后难免会出现相同的情况，此时的value可能会需要转换成链表去存储，而链表越长，对于查询性能影响越大。而且由于哈希表的查询是通过key查找value，显然只能适用于等值查找，例如id = 1，显然不太符合数据库的查询场景；
#### 有序数组
**有序数组**属于数组，数组的特点查询性能十分优秀，在数据库索引中做等值查询和范围查询都十分优秀，仅仅看查询效率的话，数组应该是最优秀的数据结构，但是在需要更新数据的时候就麻烦了，你往中间插一个记录就必须移动后面所有记录，成本很高，但是类似于一些长期不变的静态数据，有序数组是个不错的选择。
#### 二叉树
**二叉搜索树**也是一种经典的数据结构，特点是每个节点的左子树小于根节点，右子树大于根节点，一棵平衡二叉树的查询和更新复杂度都是O(log(N))。
#### n叉树
对比下来看似二叉树是一种合理的选择，但其实数据库索引并不会使用二叉树，原因是因为索引不仅仅存在内存中，也存在磁盘上，由于磁盘寻址是一个耗时操作，所以如果单纯的用二叉树结构存储大量数据的话会导致磁盘寻址花费大量时间，效率低下。其实要解决这个问题很简单，只需要将二叉树改为n叉树即可。以InnoDB为例，n值为1200，也就是说当树的高度为4时已经可以存储1200的三次方数据≈17亿，应该可以涵盖所有使用场景，而数据最多只需要寻址3次。数据库的索引也基本都是基于n叉树设计的。

## InnoDB的索引模型

InnoDB中使用了B+树的索引模型，每一个索引在InnoDB中对应一棵B+树，假设我们有一个表，id为主键，列k上有索引：

```
mysql> create table T(
id int primary key, 
k int not null, 
name varchar(16),
index (k))engine=InnoDB;
```

![](/image/InnoDB_index_model.jpg)

图中列出的分别是主键索引和非主键索引。
**主键索引**的叶子节点存放的是整行数据。在InnoDB中这也被称为聚簇索引。
**非主键索引**的叶子节点存的是主键的值。在InnoDB中也被称为二级索引。

***主键索引和非主键索引查询的查询区别：***
+ 主键索引查询：select * from T where id = 1，主键查询方式只需要搜索主键B+树。
- 非主键查询：select * from T where k = 1，需要先查询索引k所在的树，找到k对应的id，再到id的B+树中读取所有数据，比主键搜索多扫描一棵树，这个过程也称为回表，因此在应用中也应该尽量的使用主键查询方式。

## 索引维护
为了保持B+树的特性，在插入新值的时候也会做一些必要的维护。插入时需要调整数据的位置，如果数据页满了，还需要页分裂操作，即申请一个新的数据页，将部分数据迁移过去，这个操作对于性能有影响，而且原本在一个数据页的数据现在分裂到了两个数据页，空间利用率降低大约50%，当然有分裂也有合并，当相邻两个数据页由于删除操作导致利用率过低后会进行合并。

*某些建表规范中要求建表时要有自增主键，但凡事无绝对，不是所有场景下自增主键都是好的*

由于自增主键插入数据时自动获取当前ID最大值加一，所以每次插入都是追加新记录，不需要在中间插入，所以不涉及挪动数据和页分裂，而如果是使用带有业务逻辑的字段作为主键，往往不容易保证数据顺序插入，会导致写入成本较高。除了性能外，存储空间也是需要考虑的方面，如果表中有唯一字段，例如字符串类型的身份证号，那此时应该选择身份证号还是自增主键作为主键呢？由于所有非主键索引都会保存主键值，所以如果用身份证号做主键，那么每个二级索引占用20个字节左右，使用整型的话是4字节，长整型bigint的话是8字节。**显然，主键长度越小，普通索引的叶子节点越小，占用的空间也就越小**。所以在很多场景下，自增主键往往是最佳选择，兼顾了性能和空间。

## 每课一练
问题：
```
alter table T drop index k;
alter table T add index(k);
alter table T drop primary key;
alter table T add primary key(id);
```
上面的sql分别是重建普通索引和主键索引，对于这两个重建索引的方法有没有不合适的地方？如果有，更好的改进方法是什么？

-------- 

答案：首先解释一下重建索引，如果索引可能会被删除，或者由于页分裂导致数据页有漏洞，此时重建索引可以创建新的索引并且把数据按顺序插入，使得索引更加紧凑。重建索引k的方式是没有问题的，但是重建主键不合理，不论删除还是创建主键都会将整个表重建，索引连着执行两句话的话，第一个语句就白做了，这两个语句可以用alter table T engine=InnoDB代替，具体执行过程和原因会在后续的课程笔记中提到。

------

**极客时间版权所有: https://time.geekbang.org/column/article/69636**