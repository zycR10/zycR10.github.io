---
title: MySQL学习笔记 (十二) 数据库“抖动”
date: 2019-11-28 23:00:43
categories:
- MySQL
---

***本文摘要 redo log，flush***
<!--more-->
## sql突然变慢
日常中在使用MySQL的过程中会存在这样的情况，原本明明跑起来特别快的sql突然变得特别慢，但是却无法复现，因为再执行可能又非常快了，其实在前面的[学习笔记二](https://zycr10.github.io/2019/06/20/mysql-note-20190620-0)中我们曾经提到过关于redo log的概念，在数据更新的时候其实会先更新进入内存中的redo log，后续再flush到磁盘上。当内存数据页和磁盘数据不一致时，我们称这个内存页为脏页，相反就叫做干净页。所以不难想象，如果MySQL正在执行flush这样的操作，那么必定会导致瞬间抖动，其实只是在刷脏页。

## flush刷脏页的场景
* 第一种场景，InnoDB的redo log由于存在大小限制，如果redo log满了，那么自然会进行flush操作，redo log中的checkpoint会前移使得redo log有新的空间继续写入
* 第二种场景，系统内存已经不足了然而又需要新的内存页，那么此时只能淘汰掉一部分原来的内存页，如果淘汰掉的是脏页，那么自然会进行flush操作
* 第三种场景，MySQL在系统空闲的时候会自主的进行flush操作
* 第四种场景，在关闭之前需要对脏页进行flush

**分析一下这四种场景对性能的影响**
1. redo log的flush操作是尽量要避免的，因为此时系统暂时无法接受更新，更新数短时间内会跌倒0
2. 内存不够用的情况是一种常态，InnoDB是利用缓冲池管理内存，缓冲池中的内存页又分为三种情况，未使用、干净页和脏页，InnoDB的策略是尽量利用内存，当长期运行后，未使用的内存页应该很少，所以主要看看干净页和脏页，干净页的情况很简单，直接拿出来继续用就可以了，脏页的话肯定是要flush到磁盘变成干净页后继续使用，所以如果当前需要淘汰大量脏页的话肯定会对性能产生影响
3. MySQL空闲时间操作的话基本数据库没有压力，也就不会影响性能
4. 关闭之前关注性能的可能性页不太高吧

所以说影响了数据库性能的flush操作主要集中于：
1. 单次需要淘汰的脏页太多导致大量flush
2. redo log日志写满，此时更新被堵住，写性能为0
因此InnoDB存在控制脏页比例的机制去避免上述情况

## InnodDB的脏页控制策略