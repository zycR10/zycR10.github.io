---
title: MySQL学习笔记（四）深入浅出索引（下）
date: 2019-07-02 23:10:42
tags:
categories:
- MySQL
---
***本文要点：覆盖索引，最左前缀原则***
<!--more-->

**给出如下建表语句：**
```
mysql> create table T (
ID int primary key,
k int NOT NULL DEFAULT 0, 
s varchar(16) NOT NULL DEFAULT '',
index k(k))
engine=InnoDB;
```

**插入数据：**
```
insert into T values(100,1, 'aa'),(200,2,'bb'),(300,3,'cc'),(500,5,'ee'),(600,6,'ff'),(700,7,'gg');
```

**执行语句：**
```
select * from T where k between 3 and 5;
```
思考一下这句sql扫描数据的过程？

1.在索引树上找到k=3的数据，取出ID=300；
2.到ID索引树上找到ID=300的数据；
3.在索引树上继续找k=5的数据，取出ID=500；
4.到ID索引树上找到ID=500的数据；
5.在索引树上找到k=6的数据，不符合条件，结束语句

**2，4过程回到主键索引树的过程称为回表**，很明显回表额外消耗了资源和时间，经过索引优化是可以避免回表的。

## 覆盖索引
假设select id from T where k between 3 and 5;就不需要回表了，因为在索引树中存放着id字段，可以直接返回，也就是说，当索引中覆盖了所有我们需要返回的字段，那么就可以直接返回结果了，这样的索引称为覆盖索引。**由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段**

再看一个实际问题，假如有一张市民信息表，是否有必要将身份证号和名字建立联合索引？

```
CREATE TABLE `tuser` (
  `id` int(11) NOT NULL,
  `id_card` varchar(32) DEFAULT NULL,
  `name` varchar(32) DEFAULT NULL,
  `age` int(11) DEFAULT NULL,
  `ismale` tinyint(1) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `id_card` (`id_card`),
  KEY `name_age` (`name`,`age`)
) ENGINE=InnoDB
```
我们知道其实身份证号已经是唯一标识了，如果再加入姓名组成联合索引，是否是空间上的浪费呢？但是如果你的系统有一个高频请求，根据身份证号查询市民姓名，如果没有这个覆盖索引的话每次都要回表查询，当然了联合索引是空间换时间的做法，究竟什么时候需要冗余，什么业务需要这种优化是大家在工作中需要权衡和总结的。

## 最左前缀原则
* 最左前缀可以是联合索引的最左N个字段，也可以是字符串索引的最左M个字符
* 如果通过调整顺序，可以少维护一个索引，那么这个顺序可以优先考虑采用

## 索引下推
* 在索引遍历的过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数

## 每课一练

问题：有如下这样一张表
```
CREATE TABLE `geek` (
  `a` int(11) NOT NULL,
  `b` int(11) NOT NULL,
  `c` int(11) NOT NULL,
  `d` int(11) NOT NULL,
  PRIMARY KEY (`a`,`b`),
  KEY `c` (`c`),
  KEY `ca` (`c`,`a`),
  KEY `cb` (`c`,`b`)
) ENGINE=InnoDB;
```
有这样一种说法，由于历史原因，需要使用联合主键a，b，虽然c也是索引字段，但是又创建了ca，cb索引字段的原因是业务中存在这样的sql：
```
select * from geek where c=N order by a limit 1;
select * from geek where c=N order by b limit 1;
```
这样的设计合理吗？

-----

答案：
* 主键索引a，b相当于索引中order by a，b，也就是先按a排序，再按b排序
* 索引ca是先按c排序，再按a排序
* 索引cb是先按c排序，再按b排序
根据a排序的时候，由于存在索引c，并且满足主键最左前缀原则，可以走索引查询数据；
根据b排序的时候，存在索引c，但是b不满足最左前缀原则，所以无法通过索引查询数据；
所以ca索引是可以删掉的，cb索引需要保留。

----------

**极客时间版权所有: https://time.geekbang.org/column/article/69862**